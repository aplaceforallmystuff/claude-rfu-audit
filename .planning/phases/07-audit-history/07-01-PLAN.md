---
phase: 07-audit-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skill/guides/AUDIT-HISTORY.md
  - skill/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Audit reports can be saved to .planning/audits/ with timestamps"
    - "Re-auditing a project shows score delta from previous audit"
    - "History is file-based (skill remains stateless)"
    - "--history flag shows audit timeline table"
  artifacts:
    - path: "skill/guides/AUDIT-HISTORY.md"
      provides: "Complete history tracking specification"
      contains: "Storage Format"
    - path: "skill/SKILL.md"
      provides: "Process steps for history detection and saving"
      contains: "--history"
  key_links:
    - from: "skill/SKILL.md"
      to: "skill/guides/AUDIT-HISTORY.md"
      via: "guide reference"
      pattern: "guides/AUDIT-HISTORY.md"
---

<objective>
Create the audit history guide and add history functionality to SKILL.md.

Purpose: Enable tracking of audit progress over time by saving reports with metadata and detecting previous audits for comparison.

Output:
- AUDIT-HISTORY.md guide with storage format, comparison algorithm, and --history flag behavior
- SKILL.md updated with history detection, save step, and --history mode
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-audit-history/07-CONTEXT.md
@.planning/phases/07-audit-history/07-RESEARCH.md
@skill/SKILL.md
@skill/guides/INPUT-VALIDATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AUDIT-HISTORY.md guide</name>
  <files>skill/guides/AUDIT-HISTORY.md</files>
  <action>
Create skill/guides/AUDIT-HISTORY.md with:

**Storage Format:**
- Location: `.planning/audits/{project-name}/{mode}/` where mode is "full" or "quick"
- Naming: `rfu-audit-YYYYMMDD-HHMMSS.md` (timestamp-based, no milliseconds needed for manual audits)
- Project name extraction: Try package.json "name" field, fall back to directory name, normalize (lowercase, trim, hyphens for spaces)

**YAML Frontmatter:**
Document the frontmatter structure that templates will add:
```yaml
---
rfu_audit:
  version: "1.0"
  project_name: "my-cli-tool"
  project_path: "/Users/jim/Dev/my-cli-tool"
  audit_date: "2026-01-28"
  audit_mode: "full"  # or "quick"
  score: 8
  max_score: 11  # or 5 for quick
  gate_results:
    gate1: "PASS"
    gate2: "FAIL"
    # ... all gates for mode
---
```

**History Detection:**
Automatic on every audit (no flag needed):
1. Extract project name (normalized)
2. Check for `.planning/audits/{project-name}/{mode}/` directory
3. If exists, get most recent file (natural sort by timestamp filename)
4. Parse frontmatter to get previous gate results
5. If no history, proceed normally (no comparison section)

**Comparison Algorithm:**
For each gate, compare previous vs current status:
- FAIL -> PASS: `↑` improved
- PASS -> FAIL: `↓` regressed
- Same status: `=` unchanged
- N/A -> PASS/FAIL: `NEW` (newly applicable)
- PASS/FAIL -> N/A: `REMOVED` (no longer applicable)

**Inline Delta Display:**
Show deltas in two locations:
1. Executive Summary: `Score: 8/11 ↑ (was 7/11)`
2. Scorecard table: Add "Change" column showing indicator

**--history Flag:**
When invoked with `--history`, skip audit and show history table:
```
# Audit History: my-cli-tool

## Full Audits
| Date       | Score | Change | File |
|------------|-------|--------|------|
| 2026-01-30 | 8/11  | ↑ +1   | rfu-audit-20260130-091544.md |
| 2026-01-28 | 7/11  | -      | rfu-audit-20260128-143022.md |

## Quick Audits
| Date       | Score | Change | File |
|------------|-------|--------|------|
| 2026-01-27 | 4/5   | -      | rfu-audit-20260127-103312.md |

Total: 3 audits (2 full, 1 quick)
```

**Save Behavior:**
Always save (default on). After generating report:
1. Create directory if needed: `.planning/audits/{project-name}/{mode}/`
2. Write report with frontmatter to timestamped file
3. Confirm save location to user

**Error Handling:**
- No .planning directory: Create it
- Permission denied: Show error, still display report (save is convenience, not requirement)
- Corrupted frontmatter in previous audit: Skip comparison, log warning

Follow existing guide format (see INPUT-VALIDATION.md for structure patterns).
  </action>
  <verify>File exists at skill/guides/AUDIT-HISTORY.md with sections for Storage Format, YAML Frontmatter, History Detection, Comparison Algorithm, Delta Display, --history Flag, Save Behavior, Error Handling</verify>
  <done>Guide documents complete history tracking specification that SKILL.md can reference</done>
</task>

<task type="auto">
  <name>Task 2: Add history functionality to SKILL.md</name>
  <files>skill/SKILL.md</files>
  <action>
Update skill/SKILL.md with history functionality:

**1. Update Usage section:**
Add --history flag to usage examples:
```
/rfu-audit [project-path] [--quick] [--auto-analyze] [--history]
/rfu-audit ~/Dev/my-project --history
```

**2. Update Mode Selection table:**
Add row for --history mode:
| `--history` | History View | N/A | N/A | `guides/AUDIT-HISTORY.md` | Show audit timeline |

**3. Add History section after Auto-Analyze section:**
```markdown
## History Tracking

Audit results are automatically saved for comparison on re-audits.

**Save location:** `.planning/audits/{project-name}/{mode}/rfu-audit-YYYYMMDD-HHMMSS.md`

**What gets tracked:**
- Project name, path, date
- Audit mode (full or quick)
- Score and gate results
- Full report content

**On re-audit:**
- Previous audit detected automatically
- Score delta shown in Executive Summary
- Gate changes shown in Scorecard table
- Deltas: ↑ improved, ↓ regressed, = unchanged

**View history:**
Use `--history` flag to see audit timeline instead of running new audit.

For complete history tracking specification, see `guides/AUDIT-HISTORY.md`.
```

**4. Update Process section:**
Add step 0.5 (between validation and file reading) and step 9:

```markdown
0. **Validate input**: Run 6-stage validation (see Input Validation section)
1. **Check for --history flag**: If present, show audit timeline and exit (see `guides/AUDIT-HISTORY.md`)
2. **Read project files**: README, package.json, main source files
3. **Detect previous audit** (automatic):
   - Extract normalized project name
   - Check `.planning/audits/{project-name}/{mode}/` for previous audits
   - If found, load most recent for comparison
4. **Extract context (if --auto-analyze)**: [existing content]
5. **Select mode**: [existing content, renumber]
6. **Walk through each gate**: [existing content, renumber]
7. **Score each gate**: [existing content, renumber]
8. **Provide evidence**: [existing content, renumber]
9. **Generate priority matrix**: [existing content, renumber]
10. **Compute deltas** (if previous audit exists):
    - Compare gate results
    - Prepare inline delta indicators
11. **Output structured report**: [existing content, renumber]
12. **Save audit**:
    - Create `.planning/audits/{project-name}/{mode}/` if needed
    - Write report with YAML frontmatter
    - Confirm save location
```

**5. Add guide reference** at bottom of Process section:
```markdown
For history tracking details, see `guides/AUDIT-HISTORY.md`.
```

Maintain existing formatting and section order. Renumber process steps correctly.
  </action>
  <verify>SKILL.md contains: --history in usage, History Tracking section, process steps 1, 3, 10, 12 for history functionality, reference to guides/AUDIT-HISTORY.md</verify>
  <done>SKILL.md updated with complete history workflow integrated into existing process</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skill/guides/AUDIT-HISTORY.md exists and documents storage format, comparison algorithm, delta display
2. skill/SKILL.md includes --history flag in usage
3. skill/SKILL.md has History Tracking section
4. skill/SKILL.md process includes history detection (step 3), delta computation (step 10), and save (step 12)
5. Both files cross-reference each other appropriately
</verification>

<success_criteria>
- AUDIT-HISTORY.md provides complete specification for history tracking
- SKILL.md process now includes automatic history detection and save
- --history flag documented for viewing audit timeline
- Delta indicators documented (arrows for changes, NEW/REMOVED for N/A transitions)
- History is file-based (no state needed in skill)
</success_criteria>

<output>
After completion, create `.planning/phases/07-audit-history/07-01-SUMMARY.md`
</output>
