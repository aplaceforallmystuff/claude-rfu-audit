---
phase: 07-audit-history
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - skill/templates/audit-report.md
  - skill/templates/audit-report-quick.md
  - skill/reference/TEMPLATE-SPEC.md
autonomous: true

must_haves:
  truths:
    - "Audit reports include YAML frontmatter for history tracking"
    - "Reports show inline deltas when previous audit exists"
    - "Comparison shows which gates improved/regressed"
    - "Template variables documented for history features"
  artifacts:
    - path: "skill/templates/audit-report.md"
      provides: "Full audit template with frontmatter and delta display"
      contains: "rfu_audit:"
    - path: "skill/templates/audit-report-quick.md"
      provides: "Quick audit template with frontmatter and delta display"
      contains: "rfu_audit:"
    - path: "skill/reference/TEMPLATE-SPEC.md"
      provides: "Documentation of all history-related template variables"
      contains: "History Variables"
  key_links:
    - from: "skill/templates/audit-report.md"
      to: "skill/guides/AUDIT-HISTORY.md"
      via: "frontmatter format reference"
      pattern: "AUDIT-HISTORY.md"
---

<objective>
Update templates with YAML frontmatter and delta display sections, then document new variables in TEMPLATE-SPEC.md.

Purpose: Enable audit reports to be saved with machine-readable metadata and display comparison data when re-auditing.

Output:
- Both templates updated with frontmatter block and conditional delta display
- TEMPLATE-SPEC.md updated with history-related variable documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-audit-history/07-01-SUMMARY.md
@.planning/phases/07-audit-history/07-RESEARCH.md
@skill/templates/audit-report.md
@skill/templates/audit-report-quick.md
@skill/reference/TEMPLATE-SPEC.md
@skill/guides/AUDIT-HISTORY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update templates with frontmatter and delta display</name>
  <files>skill/templates/audit-report.md, skill/templates/audit-report-quick.md</files>
  <action>
**Update skill/templates/audit-report.md (full audit):**

1. Add YAML frontmatter at the very top (before # RFU Audit Report):
```yaml
---
rfu_audit:
  version: "1.0"
  project_name: "{{project_name}}"
  project_path: "{{project_path}}"
  audit_date: "{{audit_date}}"
  audit_mode: "full"
  score: {{score}}
  max_score: 11
  gate_results:
    gate1: "{{gate1_result}}"
    gate2: "{{gate2_result}}"
    gate3: "{{gate3_result}}"
    gate4: "{{gate4_result}}"
    gate5: "{{gate5_result}}"
    gate6: "{{gate6_result}}"
    gate7: "{{gate7_result}}"
    gate8: "{{gate8_result}}"
    gate9: "{{gate9_result}}"
    gate10: "{{gate10_result}}"
    gate11: "{{gate11_result}}"
---
```

2. Update Executive Summary to show delta:
```markdown
## Executive Summary

**Score: {{score}}/11{{#if has_previous}} {{score_delta}} (was {{previous_score}}/11){{/if}}** — {{rating}}

{{summary}}
```

3. Update Scorecard table to include Change column:
```markdown
## Scorecard

| Gate | Name | Status | {{#if has_previous}}Change |{{/if}}
|------|------|--------|{{#if has_previous}}--------|{{/if}}
| 1 | 5 Whys | {{gate1_status}} | {{#if has_previous}}{{gate1_change}} |{{/if}}
| 2 | Inversion | {{gate2_status}} | {{#if has_previous}}{{gate2_change}} |{{/if}}
| 3 | 10-Minute | {{gate3_status}} | {{#if has_previous}}{{gate3_change}} |{{/if}}
| 4 | Bartender | {{gate4_status}} | {{#if has_previous}}{{gate4_change}} |{{/if}}
| 5 | Wallet | {{gate5_status}} | {{#if has_previous}}{{gate5_change}} |{{/if}}
| 6 | JTBD | {{gate6_status}} | {{#if has_previous}}{{gate6_change}} |{{/if}}
| 7 | Friction | {{gate7_status}} | {{#if has_previous}}{{gate7_change}} |{{/if}}
| 8 | Second-Order | {{gate8_status}} | {{#if has_previous}}{{gate8_change}} |{{/if}}
| 9 | Occam's Razor | {{gate9_status}} | {{#if has_previous}}{{gate9_change}} |{{/if}}
| 10 | Pareto | {{gate10_status}} | {{#if has_previous}}{{gate10_change}} |{{/if}}
| 11 | Regret | {{gate11_status}} | {{#if has_previous}}{{gate11_change}} |{{/if}}

**Total: {{score}}/11{{#if has_previous}} {{score_delta}}{{/if}}**
```

4. Add history reference in footer:
```markdown
*Generated by `/rfu-audit` — [RFU Framework](https://github.com/aplaceforallmystuff/claude-rfu-audit)*
*Saved to: `.planning/audits/{{project_name_normalized}}/full/`*
<!-- History tracking: see guides/AUDIT-HISTORY.md -->
```

**Update skill/templates/audit-report-quick.md (quick audit):**

1. Add YAML frontmatter at the very top:
```yaml
---
rfu_audit:
  version: "1.0"
  project_name: "{{project_name}}"
  project_path: "{{project_path}}"
  audit_date: "{{audit_date}}"
  audit_mode: "quick"
  score: {{quick_score}}
  max_score: 5
  gate_results:
    gate1: "{{gate1_result}}"
    gate3: "{{gate3_result}}"
    gate4: "{{gate4_result}}"
    gate5: "{{gate5_result}}"
    gate9: "{{gate9_result}}"
---
```

2. Update Quick Score line to show delta:
```markdown
## Quick Score: {{quick_score}}/5{{#if has_previous}} {{score_delta}} (was {{previous_score}}/5){{/if}} — {{triage_recommendation}}
```

3. Update Quick Scorecard table to include Change column:
```markdown
## Quick Scorecard

| Gate | Name | Status | {{#if has_previous}}Change |{{/if}}
|------|------|--------|{{#if has_previous}}--------|{{/if}}
| 1 | 5 Whys | {{gate1_status}} | {{#if has_previous}}{{gate1_change}} |{{/if}}
| 3 | 10-Minute | {{gate3_status}} | {{#if has_previous}}{{gate3_change}} |{{/if}}
| 4 | Bartender | {{gate4_status}} | {{#if has_previous}}{{gate4_change}} |{{/if}}
| 5 | Wallet | {{gate5_status}} | {{#if has_previous}}{{gate5_change}} |{{/if}}
| 9 | Occam's Razor | {{gate9_status}} | {{#if has_previous}}{{gate9_change}} |{{/if}}

**Quick Score: {{quick_score}}/5{{#if has_previous}} {{score_delta}}{{/if}}**
```

4. Add history reference in footer:
```markdown
*Generated by `/rfu-audit --quick` — [RFU Framework](https://github.com/aplaceforallmystuff/claude-rfu-audit)*
*Saved to: `.planning/audits/{{project_name_normalized}}/quick/`*
<!-- History tracking: see guides/AUDIT-HISTORY.md -->
```

Note: The `{{#if has_previous}}...{{/if}}` conditionals mean those sections only render when comparing to a previous audit. First audits show clean output without delta columns.
  </action>
  <verify>Both templates start with YAML frontmatter containing rfu_audit block, Executive Summary/Quick Score shows conditional delta, Scorecard tables have conditional Change column</verify>
  <done>Templates updated to produce saveable reports with history comparison display</done>
</task>

<task type="auto">
  <name>Task 2: Document history variables in TEMPLATE-SPEC.md</name>
  <files>skill/reference/TEMPLATE-SPEC.md</files>
  <action>
Update skill/reference/TEMPLATE-SPEC.md to document history-related variables:

**1. Add new section after "Quick Mode Specific Variables":**

```markdown
---

## History Variables

These variables support audit history tracking and delta display.

### Frontmatter Variables

Used in YAML frontmatter for machine-readable metadata:

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `gate1_result` | string | Gate 1 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate2_result` | string | Gate 2 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate3_result` | string | Gate 3 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate4_result` | string | Gate 4 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate5_result` | string | Gate 5 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate6_result` | string | Gate 6 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate7_result` | string | Gate 7 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate8_result` | string | Gate 8 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate9_result` | string | Gate 9 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate10_result` | string | Gate 10 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `gate11_result` | string | Gate 11 pass/fail status | "PASS" / "FAIL" / "N/A" |
| `project_name_normalized` | string | Normalized project name for file path | "my-cli-tool" |

**Note:** Quick mode only uses gate1_result, gate3_result, gate4_result, gate5_result, gate9_result.

### Comparison Variables

Used when previous audit exists (conditional rendering):

| Variable | Type | Description | Example |
|----------|------|-------------|---------|
| `has_previous` | boolean | Whether previous audit exists | true / false |
| `previous_score` | integer | Score from previous audit | 7 |
| `score_delta` | string | Score change indicator | "↑" / "↓" / "=" |
| `gate1_change` | string | Gate 1 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate2_change` | string | Gate 2 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate3_change` | string | Gate 3 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate4_change` | string | Gate 4 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate5_change` | string | Gate 5 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate6_change` | string | Gate 6 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate7_change` | string | Gate 7 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate8_change` | string | Gate 8 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate9_change` | string | Gate 9 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate10_change` | string | Gate 10 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |
| `gate11_change` | string | Gate 11 change indicator | "↑" / "↓" / "=" / "NEW" / "REMOVED" |

**Change indicator meanings:**
- `↑` — Improved (was FAIL, now PASS)
- `↓` — Regressed (was PASS, now FAIL)
- `=` — Unchanged (same status)
- `NEW` — Newly applicable (was N/A, now PASS or FAIL)
- `REMOVED` — No longer applicable (was PASS or FAIL, now N/A)

**Note:** Quick mode only uses gate1_change, gate3_change, gate4_change, gate5_change, gate9_change.
```

**2. Update Variable Count Summary table:**
Add row for History Variables:
| History (Frontmatter) | 12 |
| History (Comparison) | 13 |

Update total: **Total Static Variables** from 98 to 123.

**3. Update Template-to-Variable Mapping section:**

Add to Full Audit Template:
```markdown
**History (if has_previous):** has_previous, previous_score, score_delta, gate1_change through gate11_change (13)
**Frontmatter:** gate1_result through gate11_result, project_name_normalized (12)
```

Add to Quick Audit Template:
```markdown
**History (if has_previous):** has_previous, previous_score, score_delta, gate1_change, gate3_change, gate4_change, gate5_change, gate9_change (8)
**Frontmatter:** gate1_result, gate3_result, gate4_result, gate5_result, gate9_result, project_name_normalized (6)
```

**4. Add Cross-Reference:**
In the Cross-References section, add:
```markdown
- **History tracking:** See `guides/AUDIT-HISTORY.md` for storage format and comparison algorithm
```

**5. Update version and date at bottom:**
```markdown
*Specification version: 1.1*
*Last updated: [current date]*
```
  </action>
  <verify>TEMPLATE-SPEC.md contains "History Variables" section with Frontmatter Variables and Comparison Variables subsections, Variable Count Summary updated to 123, Cross-References includes AUDIT-HISTORY.md</verify>
  <done>TEMPLATE-SPEC.md documents all history-related variables and their usage in both templates</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skill/templates/audit-report.md has YAML frontmatter with rfu_audit block
2. skill/templates/audit-report.md shows conditional delta in Executive Summary and Scorecard
3. skill/templates/audit-report-quick.md has YAML frontmatter with rfu_audit block
4. skill/templates/audit-report-quick.md shows conditional delta in Quick Score and Scorecard
5. skill/reference/TEMPLATE-SPEC.md documents all new variables (25 total)
6. All three files reference guides/AUDIT-HISTORY.md
</verification>

<success_criteria>
- Templates produce machine-readable frontmatter for history tracking
- Delta display is conditional (only shows when previous audit exists)
- Quick mode uses subset of variables (5 gates, not 11)
- TEMPLATE-SPEC.md is complete reference for all template variables
- First audit renders cleanly without history artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/07-audit-history/07-02-SUMMARY.md`
</output>
